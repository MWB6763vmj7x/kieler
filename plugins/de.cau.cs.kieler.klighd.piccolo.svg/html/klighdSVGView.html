<!doctype html>
<html encoding="UTF8">

<head>
<meta charset="utf-8">
<title>KlighD SVG Viewer</title>
<link rel="stylesheet"
	href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css" />
<link rel="stylesheet" href="css/jquery.uix.tree.css" />
<link
	href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css"
	rel="stylesheet">
<script
	src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
<script src="js/jquery.uix.tree.js"></script>
<script src="js/jquery.mousewheel.js"></script>
<script
	src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>

<style>
body {
	background-color: #eeeeee;
}

.navi {
	font-family: "Trebuchet MS", "Helvetica", "Arial", "Verdana",
		"sans-serif";
	font-size: 62.5%;
}

#viewport {
	width: 870px;
	height: 600px;
	background-color: #ffffff;
}

svg {
	width: 100%;
	height: 100%;
}

#tree {
	width: 180px;
}

[class*="span"] {
	margin-left: 0px;
}
</style>

<body>
	<div class="container">
		<div class="row">
			<div class="span3 navi">
				<!--input id="ip" value="localhost:8080" /-->
				<button class="btn" id="connect">Connect</button>
				<div id="messages">Unconnected</div>
				<div id="data"></div>
			</div>

			<div class="span9">
				<div data-spy="affix" data-offset-top="0" id="viewport"></div>
			</div>
		</div>
	</div>




	<script>
    var connection = null;

    $('#connect').click(function() {

      //connectionData = new WebSocket('ws://' + $('#ip').val() + '/', "protocol.data");
      var host = window.location.host;
      connection = new WebSocket('ws://' + host + '/', "protocol.svgws");

      // When the connection is open, send some data to the server
      connection.onopen = function() {
        //connection.send('Ping U'); // Send the message 'Ping' to the server
      };

      // Log errors
      connection.onerror = function(error) {
        $('#messages').html('WebSocket Error ' + error);
      };

      // Received SVG from server
      connection.onmessage = function(e) {
        // set the svg
        $('#viewport').html();
        $('#viewport').html(e.data);

        var svg = d3.select("svg");
        svg.selectAll("text").on("mousedown", function(d) {
          // get the id
          var text = this.textContent;
          // if starts with id identifier
          if (text.indexOf("de.cau.cs.kieler.id:") === 0) {
            var id = text.substring(20, text.length);
            console.log("Inner " + id);

            // send expand toggle command
            $.ajax({
              type : 'PUT',
              url : 'expand/' + id
            });

          }
        });

        var zoom = d3.behavior.zoom().on("zoom", function() {
          console.log(JSON.stringify(d3.event));
          var delta = d3.event.scale > 1 ? 3 : -3;
          $.ajax({
            type : 'PUT',
            url : 'zoom/' + delta
          });
        });

        // select root g and add zoom
        //svg.select("g").attr("data-test", "main").attr("transform",
        //    "translate(" + 0 + "," + 0 + ")");
        //svg.call(zoom);

        $("svg").bind('mousewheel', function(event, delta) {
          var deltaNorm = delta > 0 ? 3 : -3;
          $.ajax({
            type : 'PUT',
            url : 'zoom/' + deltaNorm
          });
        });

        /*$('text').each(function(i,e) {
          //var parent = e.parent();
          var id = e.textContent;
          console.log(i + " " + id + parent) ;
          e.click(function() {
            console.log("TEXT CLICK");
          });
        });*/
      };

      $('#messages').html("Connecting ...");
      setTimeout(function() {
        if (connection.readyState === WebSocket.OPEN) {
          $('#messages').html("Connected to " + window.location.host + ".");
        } else {
          $('#messages').html("Could not connect to web socket.");
          connection = null;
        }
      }, 500);

    });

    var lastpos = null;

    $('#viewport').mousedown(function(d) {
      console.log(d.screenX + " " + d.screenY);
      lastpos = {
        x : d.screenX,
        y : d.screenY
      };
    });

    $('#viewport').mousemove(function(d) {
      if (lastpos != null) {
        var delta = {
          x : lastpos.x - d.screenX,
          y : lastpos.y - d.screenY
        };
        lastpos = {
          x : d.screenX,
          y : d.screenY
        };

        if (connection != null) {
          connection.send(JSON.stringify(delta));
        }
        console.log(delta);
      }
    });

    $('#viewport').mouseup(function(d) {
      lastpos = null;
    });

    // executed
    $(function() {

      $.ajax({
        type : 'GET',
        url : 'content/',
        success : function(res) {
          $('#data').append(res);
          console.log("Success " + res);

          // register listener
          $('.file').click(function() {
            var path = $(this).attr("data-path");
                        console.log(path);
            $.ajax({
              type : 'PUT',
              url : 'resource' + path,
              success : function(res) {
                console.log("Resource: " + res);
              }
            });
          });

          $('.folder').click(function() {
            var path = $(this).attr("data-path");
            $.ajax({
              type : 'GET',
              url : 'folder' + path,
              success : function(res) {
                console.log("Folder: " + res);
              }
            });
          });

          // init tree
          $("#tree").tree();
          $("#tree_icons").tree(
              {
                toggle : function(evt, ui) {
                  var expanded = (ui.nodes.attr("aria-expanded") == "true");
                  ui.nodes.children("a").children("span.ui-icon").removeClass(
                      "ui-icon-folder-" + (expanded ? "collapsed" : "open")).addClass(
                      "ui-icon-folder-" + (expanded ? "open" : "collapsed"));
                }
              });

        },
        error : function(e) {
          console.log(e);
        }
      });
      console.log("test");

    });
  </script>



</body>

</html>